name: GitOps Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          repository: adebold/warehouse-gitops
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd
          
      - name: Sync applications
        run: |
          # Login to ArgoCD
          argocd login ${{ secrets.ARGOCD_SERVER }} \
            --username admin \
            --password ${{ secrets.ARGOCD_PASSWORD }} \
            --insecure
            
          # Sync all environments
          for env in dev staging prod; do
            argocd app sync warehouse-$env \
              --force \
              --prune \
              --retry-limit 5
              
            # Wait for sync to complete
            argocd app wait warehouse-$env \
              --sync \
              --health \
              --timeout 300
          done
          
      - name: Validate deployments
        run: |
          for env in dev staging prod; do
            SERVICE_URL=$(gcloud run services describe warehouse-$env \
              --region=us-central1 \
              --format='value(status.url)')
              
            # Health check
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL/health)
            if [ $STATUS -ne 200 ]; then
              echo "Health check failed for $env environment"
              exit 1
            fi
          done