name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
        - dev
        - staging
        - prod
      revision:
        description: 'Revision to rollback to (leave empty for previous)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets[format('GCP_SA_KEY_{0}', inputs.environment)] }}

      - name: Get current and previous revisions
        id: revisions
        run: |
          SERVICE_NAME="warehouse-${{ inputs.environment }}"
          if [ "${{ inputs.environment }}" = "prod" ]; then
            SERVICE_NAME="warehouse-prod"
          fi
          
          REVISIONS=$(gcloud run revisions list --service=$SERVICE_NAME --region=us-central1 --format="value(name)" --limit=5)
          CURRENT=$(echo "$REVISIONS" | head -1)
          PREVIOUS=$(echo "$REVISIONS" | head -2 | tail -1)
          
          if [ -n "${{ inputs.revision }}" ]; then
            TARGET="${{ inputs.revision }}"
          else
            TARGET="$PREVIOUS"
          fi
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "service=$SERVICE_NAME" >> $GITHUB_OUTPUT

      - name: Rollback to target revision
        run: |
          echo "Rolling back ${{ steps.revisions.outputs.service }} from ${{ steps.revisions.outputs.current }} to ${{ steps.revisions.outputs.target }}"
          
          gcloud run services update-traffic ${{ steps.revisions.outputs.service }} \
            --region=us-central1 \
            --to-revisions=${{ steps.revisions.outputs.target }}=100

      - name: Verify rollback
        run: |
          sleep 30
          SERVICE_URL=$(gcloud run services describe ${{ steps.revisions.outputs.service }} --region=us-central1 --format="value(status.url)")
          
          # Health check
          curl -f "$SERVICE_URL/api/health" || exit 1
          echo "âœ… Rollback successful!"

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Rollback performed on ${{ inputs.environment }}`,
              body: `### Rollback Details
              
              - **Environment**: ${{ inputs.environment }}
              - **Service**: ${{ steps.revisions.outputs.service }}
              - **From**: ${{ steps.revisions.outputs.current }}
              - **To**: ${{ steps.revisions.outputs.target }}
              - **Triggered by**: @${{ github.actor }}
              - **Time**: ${new Date().toISOString()}
              
              ### Next Steps
              - [ ] Investigate root cause
              - [ ] Fix issues in code
              - [ ] Re-deploy when ready
              `,
              labels: ['rollback', 'ops', '${{ inputs.environment }}']
            });
            
            console.log('Created rollback tracking issue:', issue.html_url);