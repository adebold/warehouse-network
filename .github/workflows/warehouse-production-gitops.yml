name: Warehouse Production Deployment (GitOps)

on:
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - '.github/workflows/warehouse-production-gitops.yml'
  workflow_dispatch:

env:
  PROJECT_ID: aindustries-warehouse
  SERVICE_NAME: warehouse-platform-v2
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev
  IMAGE_NAME: warehouse-platform-v2

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/668950927538/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions@aindustries-warehouse.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push Docker image
        run: |
          # Check if Dockerfile exists
          if [ -f apps/web/Dockerfile.monorepo ]; then
            DOCKERFILE="apps/web/Dockerfile.monorepo"
          elif [ -f apps/web/Dockerfile.gitops ]; then
            DOCKERFILE="apps/web/Dockerfile.gitops"
          elif [ -f apps/web/Dockerfile.production ]; then  
            DOCKERFILE="apps/web/Dockerfile.production"
          elif [ -f apps/web/Dockerfile ]; then
            DOCKERFILE="apps/web/Dockerfile"
          else
            echo "âŒ No Dockerfile found!"
            exit 1
          fi
          
          echo "Using $DOCKERFILE for build"
          echo "Building from repository root to include src directory"
          
          # Build the image from repository root
          docker build -f $DOCKERFILE \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/warehouse-docker/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/warehouse-docker/${{ env.IMAGE_NAME }}:latest \
            .
          
          # Push both tags
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/warehouse-docker/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/warehouse-docker/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/warehouse-docker/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300 \
            --concurrency 1000 \
            --max-instances 10 \
            --min-instances 0 \
            --port 3000 \
            --set-env-vars "NODE_ENV=production,PROJECT_ID=${{ env.PROJECT_ID }}" \
            --update-secrets "DATABASE_URL=DATABASE_URL:latest,REDIS_URL=REDIS_URL:latest,NEXTAUTH_SECRET=NEXTAUTH_SECRET:latest,NEXT_PUBLIC_GA_MEASUREMENT_ID=GA_MEASUREMENT_ID:latest" \
            --service-account "warehouse-app@aindustries-warehouse.iam.gserviceaccount.com" \
            --add-cloudsql-instances "aindustries-warehouse:us-central1:warehouse-production-db" \
            --labels "environment=production,app=warehouse,gitops=true"

      - name: Verify Deployment
        run: |
          # Get the service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "Service deployed to: $SERVICE_URL"
          
          # Wait for service to be ready
          echo "Waiting for service to be ready..."
          sleep 30
          
          # Check if service is responding
          if curl -f -s "$SERVICE_URL" -o /dev/null; then
            echo "âœ… Deployment successful! Service is responding."
            echo "ðŸŒ SkidSpace is live at: $SERVICE_URL"
          else
            echo "âš ï¸ Service deployed but may still be starting up."
            echo "Please check manually at: $SERVICE_URL"
          fi
          
      - name: Create Deployment Summary
        if: always()
        run: |
          echo "## SkidSpace Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
              --region ${{ env.REGION }} \
              --format 'value(status.url)')
            
            echo "âœ… **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **URL**: $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¨ **What's New**: Updated SkidSpace brand assets (logos, colors)" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Version**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Please Verify" >> $GITHUB_STEP_SUMMARY
            echo "1. Visit [SkidSpace.com]($SERVICE_URL)" >> $GITHUB_STEP_SUMMARY
            echo "2. Check that the new logo appears in:" >> $GITHUB_STEP_SUMMARY
            echo "   - Homepage header and footer" >> $GITHUB_STEP_SUMMARY
            echo "   - Login/Register pages" >> $GITHUB_STEP_SUMMARY  
            echo "   - Dashboard navigation" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify brand colors are #0B5FFF (blue) and #FF8A1F (orange)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi