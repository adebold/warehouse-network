name: GitOps - Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      promote_from_staging:
        description: 'Promote image from staging'
        required: true
        default: 'true'
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1
  REPOSITORY: warehouse
  IMAGE: warehouse-frontend

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        fi

  build-and-push:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.validate.outputs.version }}

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Docker Auth
      run: |-
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Build and Push Container
      run: |-
        docker build -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ needs.validate.outputs.version }}" \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:prod-latest" \
          -f docker/prod/Dockerfile .
        
        docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ needs.validate.outputs.version }}"
        docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:prod-latest"

    - name: Run Security Scan
      run: |-
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image \
          --exit-code 1 \
          --severity CRITICAL \
          "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ needs.validate.outputs.version }}"

    - name: Create Release Branch
      run: |-
        git checkout -b release/${{ needs.validate.outputs.version }}
        
        cd .gitops/overlays/prod
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        ./kustomize edit set image gcr.io/PROJECT_ID/warehouse-frontend=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ needs.validate.outputs.version }}
        
        git config --local user.email "gitops-bot@warehouse.com"
        git config --local user.name "GitOps Bot"
        git add .gitops/overlays/prod/kustomization.yaml
        git commit -m "Release ${{ needs.validate.outputs.version }}"
        git push origin release/${{ needs.validate.outputs.version }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "Release ${{ needs.validate.outputs.version }}"
        body: |
          ## Production Release ${{ needs.validate.outputs.version }}
          
          This PR updates the production environment to version ${{ needs.validate.outputs.version }}.
          
          ### Checklist
          - [ ] All tests passing
          - [ ] Security scans completed
          - [ ] Performance benchmarks reviewed
          - [ ] Rollback plan documented
          
          ### Deployment Notes
          - Image: `${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ needs.validate.outputs.version }}`
          - Commit: ${{ github.sha }}
        branch: release/${{ needs.validate.outputs.version }}
        base: main