apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: warehouse-network-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: warehouse-network.rules
    interval: 30s
    rules:
    
    # Application Health
    - alert: ApplicationDown
      expr: up{job="warehouse-network"} == 0
      for: 1m
      labels:
        severity: critical
        service: warehouse-network
      annotations:
        summary: "Warehouse Network application is down"
        description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minute."
    
    # Response Time
    - alert: HighResponseTime
      expr: histogram_quantile(0.95, http_request_duration_seconds_bucket{job="warehouse-network"}) > 2
      for: 5m
      labels:
        severity: warning
        service: warehouse-network
      annotations:
        summary: "High response time detected"
        description: "95th percentile response time is above 2 seconds (current: {{ $value }}s)"
    
    # Error Rate
    - alert: HighErrorRate
      expr: rate(http_requests_total{job="warehouse-network",status=~"5.."}[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        service: warehouse-network
      annotations:
        summary: "High error rate detected"
        description: "Error rate is above 5% (current: {{ $value | humanizePercentage }})"
    
    # Database Connection Pool
    - alert: DatabaseConnectionPoolExhausted
      expr: pg_stat_database_numbackends{datname="warehouse"} / pg_settings_max_connections > 0.8
      for: 5m
      labels:
        severity: warning
        service: database
      annotations:
        summary: "Database connection pool nearly exhausted"
        description: "Database connection usage is above 80% (current: {{ $value | humanizePercentage }})"
    
    # Memory Usage
    - alert: HighMemoryUsage
      expr: container_memory_usage_bytes{pod=~"web-app-.*"} / container_spec_memory_limit_bytes > 0.9
      for: 5m
      labels:
        severity: warning
        service: warehouse-network
      annotations:
        summary: "High memory usage in pod {{ $labels.pod }}"
        description: "Memory usage is above 90% of limit (current: {{ $value | humanizePercentage }})"
    
    # CPU Usage
    - alert: HighCPUUsage
      expr: rate(container_cpu_usage_seconds_total{pod=~"web-app-.*"}[5m]) > 0.8
      for: 5m
      labels:
        severity: warning
        service: warehouse-network
      annotations:
        summary: "High CPU usage in pod {{ $labels.pod }}"
        description: "CPU usage is above 80% (current: {{ $value | humanizePercentage }})"
    
    # Pod Restart
    - alert: PodRestartingTooOften
      expr: rate(kube_pod_container_status_restarts_total{namespace="warehouse-network"}[15m]) > 0
      for: 5m
      labels:
        severity: warning
        service: warehouse-network
      annotations:
        summary: "Pod {{ $labels.pod }} is restarting frequently"
        description: "Pod has restarted {{ $value }} times in the last 15 minutes"
    
    # Disk Usage
    - alert: HighDiskUsage
      expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes) < 0.1
      for: 5m
      labels:
        severity: critical
        service: infrastructure
      annotations:
        summary: "Disk space critically low on {{ $labels.instance }}"
        description: "Available disk space is below 10% (current: {{ $value | humanizePercentage }})"
    
    # Certificate Expiry
    - alert: SSLCertificateExpiringSoon
      expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
      for: 1h
      labels:
        severity: warning
        service: warehouse-network
      annotations:
        summary: "SSL certificate expiring soon"
        description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}"
    
    # Redis Memory
    - alert: RedisMemoryHigh
      expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
      for: 5m
      labels:
        severity: warning
        service: redis
      annotations:
        summary: "Redis memory usage is high"
        description: "Redis memory usage is above 90% (current: {{ $value | humanizePercentage }})"
    
    # Queue Backlog
    - alert: QueueBacklogHigh
      expr: redis_list_length{key="job_queue"} > 1000
      for: 10m
      labels:
        severity: warning
        service: warehouse-network
      annotations:
        summary: "Job queue backlog is high"
        description: "Job queue has {{ $value }} items pending"