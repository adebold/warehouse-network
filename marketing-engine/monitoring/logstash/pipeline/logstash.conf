input {
  tcp {
    port => 5044
    codec => json_lines
    type => "application"
  }
  
  udp {
    port => 5514
    type => "syslog"
  }
  
  http {
    port => 8080
    codec => json
    type => "webhook"
  }
}

filter {
  # Parse JSON logs
  if [type] == "application" {
    json {
      source => "message"
      target => "parsed"
    }
    
    # Extract fields from parsed JSON
    mutate {
      add_field => {
        "service" => "%{[parsed][service]}"
        "level" => "%{[parsed][level]}"
        "environment" => "%{[parsed][env]}"
        "correlation_id" => "%{[parsed][correlationId]}"
      }
    }
    
    # Parse timestamps
    date {
      match => [ "[parsed][timestamp]", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Parse syslog
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" }
    }
    
    date {
      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
  }
  
  # Add GeoIP information
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # Error detection
  if [level] in ["error", "ERROR", "Error"] or [message] =~ /error|exception|fail/i {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  # Performance metrics extraction
  if [parsed][duration] {
    ruby {
      code => "
        duration = event.get('[parsed][duration]')
        if duration
          event.set('performance.duration_ms', duration)
          if duration > 1000
            event.set('performance.slow_request', true)
          end
        end
      "
    }
  }
  
  # Security event detection
  if [parsed][event_type] in ["login_failed", "unauthorized_access", "rate_limit_exceeded"] {
    mutate {
      add_tag => [ "security" ]
    }
  }
  
  # Remove sensitive data
  mutate {
    remove_field => [ "password", "token", "api_key", "authorization" ]
  }
  
  # Add metadata
  mutate {
    add_field => {
      "cluster" => "marketing-engine"
      "processed_at" => "%{@timestamp}"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "marketing-%{[type]}-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    template_name => "marketing-template"
    template => "/usr/share/logstash/templates/elasticsearch-template.json"
    template_overwrite => true
  }
  
  # Alert on errors
  if "error" in [tags] {
    http {
      url => "${SLACK_WEBHOOK_URL}"
      http_method => "post"
      format => "json"
      mapping => {
        "text" => "âš ï¸ Error detected in %{service}"
        "attachments[0][color]" => "danger"
        "attachments[0][fields][0][title]" => "Service"
        "attachments[0][fields][0][value]" => "%{service}"
        "attachments[0][fields][1][title]" => "Error"
        "attachments[0][fields][1][value]" => "%{message}"
      }
    }
  }
  
  # Debug output (disable in production)
  if [@metadata][debug] == "true" {
    stdout {
      codec => rubydebug
    }
  }
}